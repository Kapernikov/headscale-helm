{{- if .Values.configMap.create }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "headscale.fullname" . }}
  labels:
    {{- include "headscale.labels" . | nindent 4 }}
data:
  config.yaml: |
    {{- /* Prepare a copy of the config values so we can mutate server_url */ -}}
    {{- $cfg := dict -}}
    {{- $cfg = merge $cfg .Values.config -}}
    {{- $tlsSecret := .Values.tls.secretName | default "" -}}
    {{- $modeB := and (not .Values.ingress.enabled) (ne $tlsSecret "") -}}
    {{- /* If ingress is enabled and no explicit server_url is provided, derive it from ingress host and TLS */ -}}
    {{- if and .Values.ingress.enabled (or (not (hasKey .Values.config "server_url")) (empty .Values.config.server_url)) -}}
      {{- $hasTls := or (gt (len .Values.ingress.tls) 0) (ne $tlsSecret "") -}}
      {{- $scheme := ternary "https" "http" $hasTls -}}
      {{- $host := (index .Values.ingress.hosts 0).host -}}
      {{- $_ := set $cfg "server_url" (printf "%s://%s" $scheme $host) -}}
    {{- else if or (not (hasKey .Values.config "server_url")) (empty .Values.config.server_url) -}}
      {{- /* Default to internal service URL if nothing else is set */ -}}
      {{- $_ := set $cfg "server_url" (printf "http://%s.%s.svc.cluster.local:%v" (include "headscale.fullname" .) .Release.Namespace .Values.service.port) -}}
    {{- end -}}
    {{- /* Mode B: headscale serves TLS natively */ -}}
    {{- if $modeB -}}
      {{- $_ := set $cfg "tls_cert_path" "/etc/headscale/tls/tls.crt" -}}
      {{- $_ := set $cfg "tls_key_path" "/etc/headscale/tls/tls.key" -}}
      {{- $_ := set $cfg "listen_addr" "0.0.0.0:443" -}}
    {{- end -}}
    {{- if .Values.extraDnsRecords.enabled -}}
      {{- $dnsConfigInValues := (index .Values.config "dns") | default (dict) -}}
      {{- $configPath := (index $dnsConfigInValues "extra_records_path") | default "" -}}
      {{- $path := coalesce .Values.extraDnsRecords.path $configPath "/etc/headscale/extra-dns-records.json" -}}
      {{- if not (hasKey $cfg "dns") -}}
        {{- $_ := set $cfg "dns" (dict) -}}
      {{- end -}}
      {{- $dns := index $cfg "dns" -}}
      {{- if not (hasKey $dns "extra_records_path") -}}
        {{- $_ := set $dns "extra_records_path" $path -}}
      {{- end -}}
    {{- end -}}
    {{- /* Add derp.paths when a static DERP map is provided */ -}}
    {{- if .Values.derpMap.enabled -}}
      {{- if not (hasKey $cfg "derp") -}}
        {{- $_ := set $cfg "derp" (dict) -}}
      {{- end -}}
      {{- $derp := index $cfg "derp" -}}
      {{- if not (hasKey $derp "paths") -}}
        {{- $_ := set $derp "paths" (list .Values.derpMap.path) -}}
      {{- end -}}
    {{- end -}}
    {{- /* Add policy path when policy is enabled or client advertises routes */ -}}
    {{- $needsPolicy := or .Values.policy.enabled (and .Values.client.enabled (gt (len .Values.client.advertiseRoutes) 0)) -}}
    {{- if $needsPolicy -}}
      {{- if not (hasKey $cfg "policy") -}}
        {{- $_ := set $cfg "policy" (dict) -}}
      {{- end -}}
      {{- $policy := index $cfg "policy" -}}
      {{- $policyPath := ternary .Values.policy.path "/etc/headscale/policy.json" .Values.policy.enabled -}}
      {{- $_ := set $policy "path" $policyPath -}}
    {{- end -}}
    {{- toYaml $cfg | nindent 4 }}
{{- end }}
